<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOK75 - Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .action-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .action-card:hover {
            transform: translateY(-5px);
            background: #f0f0f0;
        }
        
        .action-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .action-title {
            font-size: 18px;
            font-weight: 700;
            color: #2C3E50;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="sidebar">
            <div class="logo">
                <h2>DOK75</h2>
                <span>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</span>
            </div>
            
            <div class="user-info" id="userInfo">
                <div class="name">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                <div class="role">Ù…ÙˆØ¸Ù Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</div>
            </div>
            
            <ul class="menu">
                <li><a href="#" class="active" onclick="loadDashboard()">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                <li><a href="#" onclick="showAddPatient()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶</a></li>
                <li><a href="#" onclick="showAddAppointment()">ğŸ“… Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯</a></li>
                <li><a href="#" onclick="loadAllPatients()">ğŸ‘¥ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø¶Ù‰</a></li>
                <li><a href="#" onclick="loadAllAppointments()">ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</a></li>
                <li><a href="#" onclick="loadDoctors()">ğŸ‘¨â€âš•ï¸ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</a></li>
                <li><a href="#" onclick="logout()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
            </ul>
        </div>
        
        <div class="main-content">
            <div class="header">
                <h1 id="pageTitle">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h1>
                <button class="btn-primary" onclick="logout()" style="background: #dc3545;">
                    <span>ğŸšª</span> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                </button>
            </div>
            
            <div id="content">
                <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                <div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        let currentUser = null;
        let doctors = [];
        
        if (!token) {
            window.location.href = '/login.html';
        }
        
        async function apiRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        ...options.headers
                    }
                });
                
                const data = await response.json();
                return { response, data };
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£:', error);
                throw error;
            }
        }
        
        async function loadUserData() {
            try {
                const { response, data } = await apiRequest('/api/auth/me');
                
                if (response.ok && data.success) {
                    currentUser = data.user;
                    document.querySelector('.user-info .name').textContent = currentUser.full_name;
                    
                    if (currentUser.role === 'super_admin') {
                        window.location.href = '/admin-dashboard';
                    } else if (currentUser.role === 'doctor') {
                        window.location.href = '/doctor-dashboard';
                    }
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£:', error);
            }
        }
        
        async function loadDashboard() {
            document.getElementById('pageTitle').textContent = 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©';
            
            const html = `
                <div class="quick-actions">
                    <div class="action-card" onclick="showAddPatient()">
                        <div class="action-icon">â•</div>
                        <div class="action-title">Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯</div>
                    </div>
                    <div class="action-card" onclick="showAddAppointment()">
                        <div class="action-icon">ğŸ“…</div>
                        <div class="action-title">Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯</div>
                    </div>
                    <div class="action-card" onclick="loadAllPatients()">
                        <div class="action-icon">ğŸ‘¥</div>
                        <div class="action-title">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±Ø¶Ù‰</div>
                    </div>
                    <div class="action-card" onclick="loadAllAppointments()">
                        <div class="action-icon">ğŸ“‹</div>
                        <div class="action-title">Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</div>
                    </div>
                </div>
                
                <div class="card">
                    <h2 style="margin-bottom:20px;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©</h2>
                    <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:15px; text-align:center;">
                        <div>
                            <div style="font-size:24px; font-weight:700;" id="statsPatients">0</div>
                            <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø¶Ù‰</div>
                        </div>
                        <div>
                            <div style="font-size:24px; font-weight:700;" id="statsDoctors">0</div>
                            <div>Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</div>
                        </div>
                        <div>
                            <div style="font-size:24px; font-weight:700;" id="statsAppointments">0</div>
                            <div>Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('content').innerHTML = html;
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            try {
                const { data: patients } = await apiRequest('/api/patients');
                const { data: doctors } = await apiRequest('/api/users?role=doctor');
                const today = new Date().toISOString().split('T')[0];
                const { data: appointments } = await apiRequest(`/api/appointments/date/${today}`);
                
                document.getElementById('statsPatients').textContent = patients.patients?.length || 0;
                document.getElementById('statsDoctors').textContent = doctors.users?.length || 0;
                document.getElementById('statsAppointments').textContent = appointments.appointments?.length || 0;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', error);
            }
        }
        
        async function showAddPatient() {
            const full_name = prompt('ğŸ‘¤ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„ÙƒØ§Ù…Ù„:');
            if (!full_name) return;
            
            const phone = prompt('ğŸ“ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:');
            if (!phone) return;
            
            const age = prompt('ğŸ‚ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù…Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):');
            
            try {
                const { response, data } = await apiRequest('/api/patients', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        full_name: full_name.trim(),
                        phone: phone.trim(),
                        age: age ? parseInt(age) : null,
                        clinic_id: currentUser.clinic_id || 1
                    })
                });
                
                if (response.ok && data.success) {
                    alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­');
                    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ù„Ù‡ Ø§Ù„Ø¢Ù†ØŸ')) {
                        showAddAppointment(data.patient);
                    }
                } else {
                    alert('âŒ Ø®Ø·Ø£: ' + (data.error || 'ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©'));
                }
            } catch (error) {
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }
        
        async function showAddAppointment(selectedPatient = null) {
            // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡
            try {
                const { data: doctorsData } = await apiRequest('/api/users?role=doctor');
                doctors = doctorsData.users || [];
                
                let patientInfo = '';
                if (selectedPatient) {
                    patientInfo = `Ù„Ù„Ù…Ø±ÙŠØ¶: ${selectedPatient.full_name}`;
                }
                
                // ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ±Ù‡Ø§ Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…ØªÙƒØ§Ù…Ù„
                alert('Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù†Ù…ÙˆØ°Ø¬ Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ¹Ø¯ Ù‚Ø±ÙŠØ¨Ø§Ù‹');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£:', error);
            }
        }
        
        async function loadAllPatients() {
            document.getElementById('pageTitle').textContent = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø¶Ù‰';
            
            try {
                const { data } = await apiRequest('/api/patients');
                
                let html = `
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ğŸ‘¥ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø¶Ù‰</h2>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                                        <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                                        <th>Ø§Ù„Ø¹Ù…Ø±</th>
                                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</th>
                                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                if (data.patients && data.patients.length > 0) {
                    data.patients.forEach(patient => {
                        html += `
                            <tr>
                                <td><strong>${patient.full_name}</strong></td>
                                <td>${patient.phone}</td>
                                <td>${patient.age || '-'}</td>
                                <td>${new Date(patient.createdAt).toLocaleDateString('ar-SA')}</td>
                                <td>
                                    <button class="action-btn view-btn" onclick="viewPatient(${patient.id})">ğŸ‘ï¸ Ø¹Ø±Ø¶</button>
                                    <button class="action-btn edit-btn" onclick="showAddAppointment(${patient.id})">ğŸ“… Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯</button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    html += '<tr><td colspan="5" style="text-align:center; padding:30px;">âœ¨ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±Ø¶Ù‰</td></tr>';
                }
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('content').innerHTML = html;
                
            } catch (error) {
                console.error('Ø®Ø·Ø£:', error);
            }
        }
        
        async function loadAllAppointments() {
            document.getElementById('pageTitle').textContent = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯';
            
            try {
                const { data } = await apiRequest('/api/appointments');
                
                let html = `
                    <div class="card">
                        <h2 style="margin-bottom:20px;">ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</h2>
                `;
                
                if (data.appointments && data.appointments.length > 0) {
                    data.appointments.forEach(app => {
                        html += `
                            <div style="display:flex; align-items:center; padding:15px; border-bottom:1px solid #eee;">
                                <div style="background:#006D77; color:white; padding:8px 15px; border-radius:20px; margin-left:20px;">
                                    ${new Date(app.appointment_date).toLocaleString('ar-SA')}
                                </div>
                                <div style="flex:1;">
                                    <strong>${app.patient?.full_name}</strong>
                                    <br>
                                    <small>ğŸ‘¨â€âš•ï¸ ${app.doctor?.full_name}</small>
                                </div>
                                <span class="status-badge status-${app.status}">
                                    ${app.status === 'pending' ? 'Ù…Ø¹Ù„Ù‚' : app.status === 'confirmed' ? 'Ù…Ø¤ÙƒØ¯' : app.status === 'completed' ? 'Ù…ÙƒØªÙ…Ù„' : 'Ù…Ù„ØºÙŠ'}
                                </span>
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="text-align:center; padding:30px;">âœ¨ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯</p>';
                }
                
                html += '</div>';
                document.getElementById('content').innerHTML = html;
                
            } catch (error) {
                console.error('Ø®Ø·Ø£:', error);
            }
        }
        
        async function loadDoctors() {
            document.getElementById('pageTitle').textContent = 'Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡';
            
            try {
                const { data } = await apiRequest('/api/users?role=doctor');
                
                let html = `
                    <div class="card">
                        <h2 style="margin-bottom:20px;">ğŸ‘¨â€âš•ï¸ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</h2>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                                        <th>Ø§Ù„ØªØ®ØµØµ</th>
                                        <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                if (data.users && data.users.length > 0) {
                    data.users.forEach(doctor => {
                        html += `
                            <tr>
                                <td><strong>${doctor.full_name}</strong></td>
                                <td>${doctor.specialization?.name || doctor.department?.name || 'Ø¹Ø§Ù…'}</td>
                                <td>${doctor.phone || '-'}</td>
                                <td><span class="badge ${doctor.is_active ? 'badge-success' : 'badge-danger'}">${doctor.is_active ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}</span></td>
                            </tr>
                        `;
                    });
                } else {
                    html += '<tr><td colspan="4" style="text-align:center; padding:30px;">âœ¨ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø·Ø¨Ø§Ø¡</td></tr>';
                }
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('content').innerHTML = html;
                
            } catch (error) {
                console.error('Ø®Ø·Ø£:', error);
            }
        }
        
        function viewPatient(patientId) {
            alert('Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø±ÙŠØ¶ - Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ±Ù‡ Ù‚Ø±ÙŠØ¨Ø§Ù‹');
        }
        
        function logout() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/login.html';
            }
        }
        
        (async function init() {
            await loadUserData();
            loadDashboard();
        })();
    </script>
</body>
</html>
