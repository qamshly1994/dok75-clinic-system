<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOK75 - Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ø¨ÙŠØ¨</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .schedule-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .time-slot {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .time-slot:last-child {
            border-bottom: none;
        }
        
        .slot-time {
            background: #006D77;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 20px;
            min-width: 100px;
            text-align: center;
        }
        
        .patient-info {
            flex: 1;
            min-width: 200px;
        }
        
        .patient-name {
            font-weight: 700;
            color: #2C3E50;
            margin-bottom: 5px;
        }
        
        .patient-phone {
            font-size: 14px;
            color: #666;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-completed {
            background: #cce5ff;
            color: #004085;
        }
        
        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .confirm-btn {
            background: #28a745;
            color: white;
        }
        
        .complete-btn {
            background: #007bff;
            color: white;
        }
        
        .cancel-btn {
            background: #dc3545;
            color: white;
        }
        
        .view-btn {
            background: #17a2b8;
            color: white;
        }
        
        .edit-btn {
            background: #ffc107;
            color: #333;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th {
            background: linear-gradient(135deg, #006D77 0%, #2C3E50 100%);
            color: white;
            padding: 12px;
            font-weight: 500;
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #006D77 0%, #2C3E50 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,109,119,0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            color: #2C3E50;
        }
        
        .stat-card .label {
            font-size: 14px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .time-slot {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .slot-time {
                margin-left: 0;
                width: 100%;
            }
            
            .action-buttons {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
        <div class="sidebar">
            <div class="logo">
                <h2>DOK75</h2>
                <span>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ø¨ÙŠØ¨</span>
            </div>
            
            <div class="user-info" id="userInfo">
                <div class="name">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                <div class="role">Ø·Ø¨ÙŠØ¨</div>
            </div>
            
            <ul class="menu">
                <li><a href="#" class="active" onclick="loadDashboard()">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                <li><a href="#" onclick="loadTodayAppointments()">ğŸ“… Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…</a></li>
                <li><a href="#" onclick="loadAllAppointments()">ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</a></li>
                <li><a href="#" onclick="loadMyPatients()">ğŸ‘¥ Ù…Ø±Ø¶Ø§ÙŠ</a></li>
                <li><a href="#" onclick="loadSchedule()">â° Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„</a></li>
                <li><a href="#" onclick="loadSettings()">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a></li>
                <li><a href="#" onclick="logout()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
            </ul>
        </div>
        
        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <div class="main-content">
            <div class="header">
                <h1 id="pageTitle">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h1>
                <button class="btn-primary" onclick="logout()" style="background: #dc3545;">
                    <span>ğŸšª</span> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                </button>
            </div>
            
            <div id="content">
                <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                <div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        // ============================================
        const token = localStorage.getItem('token');
        let currentUser = null;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        if (!token) {
            window.location.href = '/login.html';
        }
        
        // ============================================
        // Ø¯Ø§Ù„Ø© Ø·Ù„Ø¨ API Ù…Ø¹ Ø§Ù„ØªÙˆÙƒÙ†
        // ============================================
        async function apiRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        ...options.headers
                    }
                });
                
                const data = await response.json();
                return { response, data };
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
                throw error;
            }
        }
        
        // ============================================
        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        // ============================================
        async function loadUserData() {
            try {
                const { response, data } = await apiRequest('/api/auth/me');
                
                if (response.ok && data.success) {
                    currentUser = data.user;
                    document.querySelector('.user-info .name').textContent = currentUser.full_name;
                    
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´Ø±Ù Ø¹Ø§Ù…ØŒ Ø­ÙˆÙ„Ù‡ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
                    if (currentUser.role === 'super_admin') {
                        window.location.href = '/admin-dashboard';
                    } else if (currentUser.role !== 'doctor') {
                        window.location.href = '/dashboard';
                    }
                } else {
                    console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', data);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£:', error);
            }
        }
        
        // ============================================
        // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯Ø© (Ù…Ø·ÙˆØ±Ø© ÙˆÙ…Ø¤Ù…Ù†Ø©)
        // ============================================
        async function showAddPatient() {
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø¹ÙŠØ§Ø¯Ø©
            if (!currentUser) {
                alert('âŒ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
                return;
            }
            
            if (!currentUser.clinic_id) {
                alert('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹ÙŠØ§Ø¯Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø­Ø³Ø§Ø¨ÙƒØŒ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø´Ø±Ù');
                return;
            }
            
            // Ø·Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
            const full_name = prompt('ğŸ‘¤ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„ÙƒØ§Ù…Ù„:');
            if (!full_name) return;
            
            const phone = prompt('ğŸ“ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:');
            if (!phone) return;
            
            const age = prompt('ğŸ‚ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù…Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):');
            
            // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ÙŠØ¶:\n${full_name}`)) return;
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
            const loadingAlert = alert('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ÙŠØ¶...');
            
            try {
                console.log('ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶:', { 
                    full_name, 
                    phone, 
                    age: age ? parseInt(age) : null,
                    clinic_id: currentUser.clinic_id 
                });
                
                const { response, data } = await apiRequest('/api/patients', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        full_name: full_name.trim(),
                        phone: phone.trim(),
                        age: age ? parseInt(age) : null,
                        clinic_id: currentUser.clinic_id
                    })
                });
                
                console.log('ğŸ“¥ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù…:', { status: response.status, data });
                
                if (response.ok && data.success) {
                    alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­');
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰
                    if (document.getElementById('pageTitle').textContent === 'Ù…Ø±Ø¶Ø§ÙŠ') {
                        loadMyPatients();
                    } else {
                        loadDashboard();
                    }
                } else {
                    alert('âŒ Ø®Ø·Ø£: ' + (data.error || data.message || 'ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©'));
                    console.error('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', data);
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
            }
        }
        
        // ============================================
        // ØªØ­Ù…ÙŠÙ„ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…
        // ============================================
        async function loadTodayAppointments() {
            document.getElementById('pageTitle').textContent = 'Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…';
            
            if (!currentUser) {
                document.getElementById('content').innerHTML = '<p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>';
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            
            try {
                const { response, data } = await apiRequest(`/api/appointments/doctor/${currentUser.id}?date=${today}`);
                
                let html = '<div class="schedule-card"><h2 style="margin-bottom: 20px;">ğŸ“… Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…</h2>';
                
                if (response.ok && data.appointments && data.appointments.length > 0) {
                    data.appointments.forEach(app => {
                        html += `
                            <div class="time-slot">
                                <div class="slot-time">
                                    ${new Date(app.appointment_date).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}
                                </div>
                                <div class="patient-info">
                                    <div class="patient-name">${app.patient?.full_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                                    <div class="patient-phone">ğŸ“ ${app.patient?.phone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div>
                                </div>
                                <span class="status-badge status-${app.status}">
                                    ${app.status === 'pending' ? 'Ù…Ø¹Ù„Ù‚' :
                                      app.status === 'confirmed' ? 'Ù…Ø¤ÙƒØ¯' :
                                      app.status === 'completed' ? 'Ù…ÙƒØªÙ…Ù„' : 'Ù…Ù„ØºÙŠ'}
                                </span>
                                <div class="action-buttons">
                                    ${app.status === 'pending' ? 
                                        `<button class="action-btn confirm-btn" onclick="updateStatus(${app.id}, 'confirmed')">ØªØ£ÙƒÙŠØ¯</button>` : ''}
                                    ${app.status === 'confirmed' ? 
                                        `<button class="action-btn complete-btn" onclick="updateStatus(${app.id}, 'completed')">Ø¥ØªÙ…Ø§Ù…</button>` : ''}
                                    ${app.status !== 'cancelled' && app.status !== 'completed' ? 
                                        `<button class="action-btn cancel-btn" onclick="updateStatus(${app.id}, 'cancelled')">Ø¥Ù„ØºØ§Ø¡</button>` : ''}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="text-align: center; padding: 20px;">âœ¨ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù„Ù„ÙŠÙˆÙ…</p>';
                }
                
                html += '</div>';
                document.getElementById('content').innerHTML = html;
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯:', error);
                document.getElementById('content').innerHTML = '<p class="error">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</p>';
            }
        }
        
        // ============================================
        // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
        // ============================================
        async function loadAllAppointments() {
            document.getElementById('pageTitle').textContent = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯';
            
            try {
                const { response, data } = await apiRequest('/api/appointments');
                
                let html = '<div class="schedule-card"><h2 style="margin-bottom: 20px;">ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</h2>';
                
                if (response.ok && data.appointments && data.appointments.length > 0) {
                    data.appointments.forEach(app => {
                        html += `
                            <div class="time-slot">
                                <div class="slot-time">
                                    ${new Date(app.appointment_date).toLocaleString('ar-SA')}
                                </div>
                                <div class="patient-info">
                                    <div class="patient-name">${app.patient?.full_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                                    <div class="patient-phone">ğŸ“ ${app.patient?.phone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div>
                                </div>
                                <span class="status-badge status-${app.status}">
                                    ${app.status === 'pending' ? 'Ù…Ø¹Ù„Ù‚' :
                                      app.status === 'confirmed' ? 'Ù…Ø¤ÙƒØ¯' :
                                      app.status === 'completed' ? 'Ù…ÙƒØªÙ…Ù„' : 'Ù…Ù„ØºÙŠ'}
                                </span>
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="text-align: center; padding: 20px;">âœ¨ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯</p>';
                }
                
                html += '</div>';
                document.getElementById('content').innerHTML = html;
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯:', error);
                document.getElementById('content').innerHTML = '<p class="error">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</p>';
            }
        }
        
        // ============================================
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯
        // ============================================
        async function updateStatus(appointmentId, status) {
            try {
                const { response, data } = await apiRequest(`/api/appointments/${appointmentId}/status`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status })
                });
                
                if (response.ok && data.success) {
                    alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
                    loadTodayAppointments(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
                } else {
                    alert('âŒ Ø®Ø·Ø£: ' + (data.error || 'ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«'));
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }
        
        // ============================================
        // ØªØ­Ù…ÙŠÙ„ Ù…Ø±Ø¶Ø§ÙŠ
        // ============================================
        async function loadMyPatients() {
            document.getElementById('pageTitle').textContent = 'Ù…Ø±Ø¶Ø§ÙŠ';
            
            try {
                const { response, data } = await apiRequest('/api/patients');
                
                let html = `
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±Ø¶Ø§ÙŠ</h2>
                            <button class="btn-primary" onclick="showAddPatient()">
                                <span>+</span> Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯
                            </button>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                                        <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                                        <th>Ø§Ù„Ø¹Ù…Ø±</th>
                                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</th>
                                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                if (response.ok && data.patients && data.patients.length > 0) {
                    data.patients.forEach(patient => {
                        html += `
                            <tr>
                                <td><strong>${patient.full_name}</strong></td>
                                <td>${patient.phone}</td>
                                <td>${patient.age || '-'}</td>
                                <td>${new Date(patient.createdAt).toLocaleDateString('ar-SA')}</td>
                                <td>
                                    <button class="action-btn view-btn" onclick="viewPatient(${patient.id})">ğŸ‘ï¸ Ø¹Ø±Ø¶</button>
                                    <button class="action-btn edit-btn" onclick="editPatient(${patient.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    html += `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 30px;">
                                âœ¨ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±Ø¶Ù‰ Ø¨Ø¹Ø¯<br>
                                <button class="btn-primary" onclick="showAddPatient()" style="margin-top: 15px;">
                                    + Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ù…Ø±ÙŠØ¶
                                </button>
                            </td>
                        </tr>
                    `;
                }
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('content').innerHTML = html;
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰:', error);
                document.getElementById('content').innerHTML = '<p class="error">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰</p>';
            }
        }
        
        // ============================================
        // Ø¹Ø±Ø¶ Ù…Ø±ÙŠØ¶
        // ============================================
        async function viewPatient(patientId) {
            try {
                const { response, data } = await apiRequest(`/api/patients/${patientId}`);
                
                if (response.ok && data.success) {
                    const p = data.patient;
                    alert(`
                        ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${p.full_name}
                        ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${p.phone}
                        ğŸ‚ Ø§Ù„Ø¹Ù…Ø±: ${p.age || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                        ğŸ“‹ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨ÙŠ: ${p.medical_history || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
                        ğŸ’Š Ø§Ù„Ø£Ø¯ÙˆÙŠØ©: ${p.medications || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
                        âš ï¸ Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©: ${p.allergies || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
                    `);
                } else {
                    alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶');
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }
        
        // ============================================
        // ØªØ¹Ø¯ÙŠÙ„ Ù…Ø±ÙŠØ¶
        // ============================================
        async function editPatient(patientId) {
            // Ù‡Ø°Ù‡ Ø¯Ø§Ù„Ø© Ø¨Ø³ÙŠØ·Ø©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ·ÙˆÙŠØ±Ù‡Ø§ Ù„ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ ØªØ¹Ø¯ÙŠÙ„
            alert('Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø±ÙŠØ¨Ø§Ù‹');
        }
        
        // ============================================
        // ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„
        // ============================================
        function loadSchedule() {
            document.getElementById('pageTitle').textContent = 'Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„';
            document.getElementById('content').innerHTML = `
                <div class="schedule-card">
                    <h2>â° Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„</h2>
                    <p style="text-align: center; padding: 30px;">Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„ Ù‚Ø±ÙŠØ¨Ø§Ù‹</p>
                </div>
            `;
        }
        
        // ============================================
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        // ============================================
        function loadSettings() {
            document.getElementById('pageTitle').textContent = 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª';
            document.getElementById('content').innerHTML = `
                <div class="schedule-card">
                    <h2>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
                    <p style="text-align: center; padding: 30px;">Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø±ÙŠØ¨Ø§Ù‹</p>
                </div>
            `;
        }
        
        // ============================================
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        // ============================================
        async function loadDashboard() {
            document.getElementById('pageTitle').textContent = 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©';
            
            if (!currentUser) {
                document.getElementById('content').innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>';
                return;
            }
            
            try {
                // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© (ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ±Ù‡Ø§)
                const today = new Date().toISOString().split('T')[0];
                const { data: todayData } = await apiRequest(`/api/appointments/doctor/${currentUser.id}?date=${today}`);
                const { data: allData } = await apiRequest('/api/patients');
                
                const todayCount = todayData?.appointments?.length || 0;
                const patientsCount = allData?.patients?.length || 0;
                
                const html = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="value">${todayCount}</div>
                            <div class="label">Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…</div>
                        </div>
                        <div class="stat-card">
                            <div class="value">${patientsCount}</div>
                            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø¶Ù‰</div>
                        </div>
                        <div class="stat-card">
                            <div class="value">0</div>
                            <div class="label">Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div>
                        </div>
                        <div class="stat-card">
                            <div class="value">0</div>
                            <div class="label">Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('content').innerHTML = html;
                
                // Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…
                if (todayCount > 0) {
                    await loadTodayAppointments();
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', error);
            }
        }
        
        // ============================================
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        // ============================================
        function logout() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/login.html';
            }
        }
        
        // ============================================
        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
        // ============================================
        (async function init() {
            await loadUserData();
            loadDashboard();
        })();
    </script>
</body>
</html>
