<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOK75 - Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ø¨ÙŠØ¨</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* Ø£Ù†Ù…Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© */
        .departments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .department-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 2px solid transparent;
        }
        
        .department-card:hover {
            transform: translateY(-5px);
            border-color: #006D77;
        }
        
        .department-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .department-name {
            font-size: 18px;
            font-weight: 700;
            color: #2C3E50;
        }
        
        .questionnaire-form {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .form-section h3 {
            color: #006D77;
            margin-bottom: 20px;
        }
        
        .question-group {
            margin-bottom: 15px;
        }
        
        .question-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2C3E50;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-questionnaire {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            margin: 0 3px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            width: 90%;
            max-width: 800px;
            margin: 50px auto;
            border-radius: 15px;
            padding: 30px;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .close-modal:hover {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
        <div class="sidebar">
            <div class="logo">
                <h2>DOK75</h2>
                <span>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ø¨ÙŠØ¨</span>
            </div>
            
            <div class="user-info" id="userInfo">
                <div class="name">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                <div class="role">Ø·Ø¨ÙŠØ¨</div>
            </div>
            
            <ul class="menu">
                <li><a href="#" class="active" onclick="showDepartments()">ğŸ¥ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</a></li>
                <li><a href="#" onclick="loadMyPatients()">ğŸ‘¥ Ù…Ø±Ø¶Ø§ÙŠ</a></li>
                <li><a href="#" onclick="loadTodayAppointments()">ğŸ“… Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…</a></li>
                <li><a href="#" onclick="loadAllAppointments()">ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</a></li>
                <li><a href="#" onclick="loadSettings()">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a></li>
                <li><a href="#" onclick="logout()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
            </ul>
        </div>
        
        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <div class="main-content">
            <div class="header">
                <h1 id="pageTitle">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</h1>
                <button class="btn-primary" onclick="logout()" style="background: #dc3545;">
                    <span>ğŸšª</span> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                </button>
            </div>
            
            <div id="content">
                <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                <div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù† -->
    <div id="questionnaireModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeQuestionnaireModal()">&times;</span>
            <h2 id="modalTitle" style="margin-bottom: 20px;">Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø§Ù„Ù…Ø±ÙŠØ¶</h2>
            <div id="questionnaireForm"></div>
        </div>
    </div>

    <script>
        // ============================================
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        // ============================================
        const token = localStorage.getItem('token');
        let currentUser = null;
        let currentDepartment = null;
        let selectedPatient = null;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        if (!token) {
            window.location.href = '/login.html';
        }
        
        // ============================================
        // Ø¯Ø§Ù„Ø© Ø·Ù„Ø¨ API Ù…Ø¹ Ø§Ù„ØªÙˆÙƒÙ†
        // ============================================
        async function apiRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        ...options.headers
                    }
                });
                
                const data = await response.json();
                return { response, data };
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
                throw error;
            }
        }
        
        // ============================================
        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        // ============================================
        async function loadUserData() {
            try {
                const { response, data } = await apiRequest('/api/auth/me');
                
                if (response.ok && data.success) {
                    currentUser = data.user;
                    document.querySelector('.user-info .name').textContent = currentUser.full_name;
                    
                    if (currentUser.role === 'super_admin') {
                        window.location.href = '/admin-dashboard';
                    } else if (currentUser.role === 'receptionist') {
                        window.location.href = '/reception-dashboard';
                    }
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£:', error);
            }
        }
        
        // ============================================
        // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        // ============================================
        async function showDepartments() {
            document.getElementById('pageTitle').textContent = 'Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…';
            
            try {
                const { response, data } = await apiRequest('/api/departments');
                
                let html = '<div class="departments-grid">';
                
                const departments = [
                    { id: 1, name: 'Ø·Ø¨ Ø¹Ø§Ù…', icon: 'ğŸ’Š' },
                    { id: 2, name: 'Ø£Ø³Ù†Ø§Ù†', icon: 'ğŸ¦·' },
                    { id: 3, name: 'Ù„ÙŠØ²Ø±', icon: 'ğŸ”¬' },
                    { id: 4, name: 'ØªØ¬Ù…ÙŠÙ„', icon: 'ğŸ’†ğŸ»' },
                    { id: 5, name: 'ØªØºØ°ÙŠØ©', icon: 'ğŸ¥—' },
                    { id: 6, name: 'Ø¹Ù„Ø§Ø¬ Ø·Ø¨ÙŠØ¹ÙŠ', icon: 'âœ¨' }
                ];
                
                departments.forEach(dept => {
                    html += `
                        <div class="department-card" onclick="selectDepartment(${dept.id}, '${dept.name}', '${dept.icon}')">
                            <div class="department-icon">${dept.icon}</div>
                            <div class="department-name">${dept.name}</div>
                        </div>
                    `;
                });
                
                html += '</div>';
                document.getElementById('content').innerHTML = html;
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£:', error);
            }
        }
        
        // ============================================
        // Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø³Ù…
        // ============================================
        function selectDepartment(id, name, icon) {
            currentDepartment = { id, name, icon };
            loadDepartmentPatients();
        }
        
        // ============================================
        // ØªØ­Ù…ÙŠÙ„ Ù…Ø±Ø¶Ù‰ Ø§Ù„Ù‚Ø³Ù…
        // ============================================
        async function loadDepartmentPatients() {
            document.getElementById('pageTitle').textContent = `Ù…Ø±Ø¶Ù‰ Ù‚Ø³Ù… ${currentDepartment.name}`;
            
            try {
                const { response, data } = await apiRequest('/api/patients');
                
                let html = `
                    <div style="margin-bottom: 20px;">
                        <button class="btn-primary" onclick="showDepartments()">
                            â† Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø£Ù‚Ø³Ø§Ù…
                        </button>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">${currentDepartment.icon} Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰</h2>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                                        <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                                        <th>Ø§Ù„Ø¹Ù…Ø±</th>
                                        <th>Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯</th>
                                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                if (response.ok && data.patients && data.patients.length > 0) {
                    data.patients.forEach(patient => {
                        const lastAppointment = patient.appointments && patient.appointments[0] 
                            ? new Date(patient.appointments[0].appointment_date).toLocaleDateString('ar-SA')
                            : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
                        
                        html += `
                            <tr>
                                <td><strong>${patient.full_name}</strong></td>
                                <td>${patient.phone}</td>
                                <td>${patient.age || '-'}</td>
                                <td>${lastAppointment}</td>
                                <td>
                                    <button class="action-btn view-btn" onclick="viewPatientDetails(${patient.id})">ğŸ‘ï¸ Ø¹Ø±Ø¶</button>
                                    <button class="action-btn edit-btn" onclick="openQuestionnaire(${patient.id}, '${patient.full_name}')">ğŸ“ Ø§Ø³ØªØ¨ÙŠØ§Ù†</button>
                                    <button class="action-btn confirm-btn" onclick="addMedicalNote(${patient.id})">â• Ù…Ù„Ø§Ø­Ø¸Ø©</button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    html += `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 30px;">
                                âœ¨ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±Ø¶Ù‰ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…
                            </td>
                        </tr>
                    `;
                }
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('content').innerHTML = html;
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰:', error);
            }
        }
        
        // ============================================
        // ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†
        // ============================================
        function openQuestionnaire(patientId, patientName) {
            selectedPatient = { id: patientId, name: patientName };
            document.getElementById('modalTitle').textContent = `Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø§Ù„Ù…Ø±ÙŠØ¶: ${patientName}`;
            
            let formHtml = `
                <form id="questionnaireFormElement" onsubmit="submitQuestionnaire(event)">
                    <input type="hidden" name="patient_id" value="${patientId}">
                    <input type="hidden" name="department_id" value="${currentDepartment.id}">
            `;
            
            // Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø§Ù„ØªØºØ°ÙŠØ©
            if (currentDepartment.name === 'ØªØºØ°ÙŠØ©') {
                formHtml += `
                    <div class="form-section">
                        <h3>ğŸ¥— Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø§Ù„ØªØºØ°ÙŠØ©</h3>
                        
                        <div class="question-group">
                            <label class="question-label">1. Ù‡Ù„ ØªØªÙ†Ø§ÙˆÙ„ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø«Ù„Ø§Ø« Ø¨Ø§Ù†ØªØ¸Ø§Ù…ØŸ</label>
                            <div class="radio-group">
                                <label class="radio-option"><input type="radio" name="meals_regular" value="Ø¯Ø§Ø¦Ù…Ø§"> Ø¯Ø§Ø¦Ù…Ø§Ù‹</label>
                                <label class="radio-option"><input type="radio" name="meals_regular" value="ØºØ§Ù„Ø¨Ø§"> ØºØ§Ù„Ø¨Ø§Ù‹</label>
                                <label class="radio-option"><input type="radio" name="meals_regular" value="Ù†Ø§Ø¯Ø±Ø§"> Ù†Ø§Ø¯Ø±Ø§Ù‹</label>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <label class="question-label">2. Ù…Ø§ Ù‡ÙŠ Ø£Ù‡Ù… ÙˆØ¬Ø¨Ø© Ù…Ù† Ø§Ù„ÙˆØ¬Ø¨Ø§Øª Ø§Ù„Ø«Ù„Ø§Ø« Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„ÙƒØŸ</label>
                            <div class="radio-group">
                                <label class="radio-option"><input type="radio" name="important_meal" value="ÙØ·ÙˆØ±"> ÙØ·ÙˆØ±</label>
                                <label class="radio-option"><input type="radio" name="important_meal" value="ØºØ¯Ø§Ø¡"> ØºØ¯Ø§Ø¡</label>
                                <label class="radio-option"><input type="radio" name="important_meal" value="Ø¹Ø´Ø§Ø¡"> Ø¹Ø´Ø§Ø¡</label>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <label class="question-label">3. Ù‡Ù„ ØªØªÙ†Ø§ÙˆÙ„ Ø§Ù„Ø®Ø¶Ø§Ø± ÙˆØ§Ù„ÙÙˆØ§ÙƒÙ‡ ÙŠÙˆÙ…ÙŠØ§Ù‹ØŸ</label>
                            <div class="radio-group">
                                <label class="radio-option"><input type="radio" name="fruits_veggies" value="Ø¯Ø§Ø¦Ù…Ø§"> Ø¯Ø§Ø¦Ù…Ø§Ù‹</label>
                                <label class="radio-option"><input type="radio" name="fruits_veggies" value="ØºØ§Ù„Ø¨Ø§"> ØºØ§Ù„Ø¨Ø§Ù‹</label>
                                <label class="radio-option"><input type="radio" name="fruits_veggies" value="Ù†Ø§Ø¯Ø±Ø§"> Ù†Ø§Ø¯Ø±Ø§Ù‹</label>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <label class="question-label">4. Ù‡Ù„ ØªØªÙ†Ø§ÙˆÙ„ ÙˆØ¬Ø¨Ø© Ø§Ù„Ø¥ÙØ·Ø§Ø± Ø¨Ø§Ù†ØªØ¸Ø§Ù…ØŸ</label>
                            <div class="radio-group">
                                <label class="radio-option"><input type="radio" name="breakfast_regular" value="Ø¯Ø§Ø¦Ù…Ø§"> Ø¯Ø§Ø¦Ù…Ø§Ù‹</label>
                                <label class="radio-option"><input type="radio" name="breakfast_regular" value="ØºØ§Ù„Ø¨Ø§"> ØºØ§Ù„Ø¨Ø§Ù‹</label>
                                <label class="radio-option"><input type="radio" name="breakfast_regular" value="Ù†Ø§Ø¯Ø±Ø§"> Ù†Ø§Ø¯Ø±Ø§Ù‹</label>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <label class="question-label">5. ÙˆÙ‚Øª ØªÙ†Ø§ÙˆÙ„ Ø§Ù„Ø¥ÙØ·Ø§Ø±:</label>
                            <div class="radio-group">
                                <label class="radio-option"><input type="radio" name="breakfast_time" value="Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©"> Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
                                <label class="radio-option"><input type="radio" name="breakfast_time" value="ÙÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©"> ÙÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
                                <label class="radio-option"><input type="radio" name="breakfast_time" value="ÙˆÙ‚Øª Ø¢Ø®Ø±"> ÙˆÙ‚Øª Ø¢Ø®Ø±</label>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø§Ù„Ø£Ø³Ù†Ø§Ù†
            else if (currentDepartment.name === 'Ø£Ø³Ù†Ø§Ù†') {
                formHtml += `
                    <div class="form-section">
                        <h3>ğŸ¦· Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø§Ù„Ø£Ø³Ù†Ø§Ù†</h3>
                        
                        <div class="question-group">
                            <label class="question-label">1. Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø³Ù†Ø§Ù† ÙŠÙˆÙ…ÙŠØ§Ù‹ØŸ</label>
                            <div class="radio-group">
                                <label class="radio-option"><input type="radio" name="brushing_frequency" value="Ù…Ø±Ø©"> Ù…Ø±Ø©</label>
                                <label class="radio-option"><input type="radio" name="brushing_frequency" value="Ù…Ø±ØªÙŠÙ†"> Ù…Ø±ØªÙŠÙ†</label>
                                <label class="radio-option"><input type="radio" name="brushing_frequency" value="Ø«Ù„Ø§Ø«"> Ø«Ù„Ø§Ø«</label>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <label class="question-label">2. Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø© Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø£Ø³Ù†Ø§Ù†ØŸ</label>
                            <div class="radio-group">
                                <label class="radio-option"><input type="radio" name="last_visit" value="Ø£Ù‚Ù„ Ù…Ù† 6 Ø´Ù‡ÙˆØ±"> Ø£Ù‚Ù„ Ù…Ù† 6 Ø´Ù‡ÙˆØ±</label>
                                <label class="radio-option"><input type="radio" name="last_visit" value="Ø³Ù†Ø©"> Ø³Ù†Ø©</label>
                                <label class="radio-option"><input type="radio" name="last_visit" value="Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ù†Ø©"> Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ù†Ø©</label>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <label class="question-label">3. Ù‡Ù„ ØªØ¹Ø§Ù†ÙŠ Ù…Ù† Ù†Ø²ÙŠÙ Ø§Ù„Ù„Ø«Ø©ØŸ</label>
                            <div class="radio-group">
                                <label class="radio-option"><input type="radio" name="gum_bleeding" value="Ù†Ø¹Ù…"> Ù†Ø¹Ù…</label>
                                <label class="radio-option"><input type="radio" name="gum_bleeding" value="Ù„Ø§"> Ù„Ø§</label>
                                <label class="radio-option"><input type="radio" name="gum_bleeding" value="Ø£Ø­ÙŠØ§Ù†Ø§"> Ø£Ø­ÙŠØ§Ù†Ø§Ù‹</label>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø§Ù„Ù„ÙŠØ²Ø±
            else if (currentDepartment.name === 'Ù„ÙŠØ²Ø±') {
                formHtml += `
                    <div class="form-section">
                        <h3>ğŸ”¬ Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø§Ù„Ù„ÙŠØ²Ø±</h3>
                        
                        <div class="question-group">
                            <label class="question-label">1. Ù†ÙˆØ¹ Ø¨Ø´Ø±ØªÙƒØŸ</label>
                            <div class="radio-group">
                                <label class="radio-option"><input type="radio" name="skin_type" value="Ø¯Ù‡Ù†ÙŠØ©"> Ø¯Ù‡Ù†ÙŠØ©</label>
                                <label class="radio-option"><input type="radio" name="skin_type" value="Ø¬Ø§ÙØ©"> Ø¬Ø§ÙØ©</label>
                                <label class="radio-option"><input type="radio" name="skin_type" value="Ù…Ø®ØªÙ„Ø·Ø©"> Ù…Ø®ØªÙ„Ø·Ø©</label>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <label class="question-label">2. Ù‡Ù„ Ø£Ø¬Ø±ÙŠØª Ø¬Ù„Ø³Ø§Øª Ù„ÙŠØ²Ø± Ø³Ø§Ø¨Ù‚Ø©ØŸ</label>
                            <div class="radio-group">
                                <label class="radio-option"><input type="radio" name="previous_laser" value="Ù†Ø¹Ù…"> Ù†Ø¹Ù…</label>
                                <label class="radio-option"><input type="radio" name="previous_laser" value="Ù„Ø§"> Ù„Ø§</label>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <label class="question-label">3. Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø³ÙŠØ© Ø¬Ù„Ø¯ÙŠØ©ØŸ</label>
                            <div class="radio-group">
                                <label class="radio-option"><input type="radio" name="skin_sensitivity" value="Ù†Ø¹Ù…"> Ù†Ø¹Ù…</label>
                                <label class="radio-option"><input type="radio" name="skin_sensitivity" value="Ù„Ø§"> Ù„Ø§</label>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨
            formHtml += `
                    <div class="form-section">
                        <h3>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨</h3>
                        <div class="question-group">
                            <textarea name="doctor_notes" rows="4" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px;" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..."></textarea>
                        </div>
                    </div>
                    
                    <div style="text-align: left; margin-top: 20px;">
                        <button type="submit" class="btn-primary" style="padding:12px 25px;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†</button>
                    </div>
                </form>
            `;
            
            document.getElementById('questionnaireForm').innerHTML = formHtml;
            document.getElementById('questionnaireModal').style.display = 'block';
        }
        
        // ============================================
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†
        // ============================================
        async function submitQuestionnaire(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = {};
            
            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
            if (currentDepartment.name === 'ØªØºØ°ÙŠØ©') {
                data.nutrition = {
                    meals_regular: formData.get('meals_regular'),
                    important_meal: formData.get('important_meal'),
                    fruits_veggies: formData.get('fruits_veggies'),
                    breakfast_regular: formData.get('breakfast_regular'),
                    breakfast_time: formData.get('breakfast_time'),
                    notes: formData.get('doctor_notes')
                };
            } else if (currentDepartment.name === 'Ø£Ø³Ù†Ø§Ù†') {
                data.dentistry = {
                    brushing_frequency: formData.get('brushing_frequency'),
                    last_visit: formData.get('last_visit'),
                    gum_bleeding: formData.get('gum_bleeding'),
                    notes: formData.get('doctor_notes')
                };
            } else if (currentDepartment.name === 'Ù„ÙŠØ²Ø±') {
                data.laser = {
                    skin_type: formData.get('skin_type'),
                    previous_laser: formData.get('previous_laser'),
                    skin_sensitivity: formData.get('skin_sensitivity'),
                    notes: formData.get('doctor_notes')
                };
            }
            
            data.patient_id = parseInt(formData.get('patient_id'));
            data.department_id = parseInt(formData.get('department_id'));
            
            try {
                const { response, data: result } = await apiRequest('/api/questionnaires', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                if (response.ok && result.success) {
                    alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø¨Ù†Ø¬Ø§Ø­');
                    closeQuestionnaireModal();
                } else {
                    alert('âŒ Ø®Ø·Ø£: ' + (result.error || 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸'));
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }
        
        // ============================================
        // Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†
        // ============================================
        function closeQuestionnaireModal() {
            document.getElementById('questionnaireModal').style.display = 'none';
        }
        
        // ============================================
        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø±ÙŠØ¶
        // ============================================
        async function viewPatientDetails(patientId) {
            try {
                const { response, data } = await apiRequest(`/api/patients/${patientId}`);
                
                if (response.ok && data.success) {
                    const p = data.patient;
                    
                    // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                    const { data: qData } = await apiRequest(`/api/questionnaires/patient/${patientId}`);
                    
                    let questionnairesHtml = '';
                    if (qData.questionnaires && qData.questionnaires.length > 0) {
                        questionnairesHtml = '<h3 style="margin:20px 0 10px;">ğŸ“‹ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>';
                        qData.questionnaires.forEach(q => {
                            questionnairesHtml += `
                                <div style="background:#f8f9fa; padding:15px; margin:10px 0; border-radius:5px;">
                                    <p><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${q.department?.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                                    <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(q.created_at).toLocaleString('ar-SA')}</p>
                                    <p><strong>Ø§Ù„Ø·Ø¨ÙŠØ¨:</strong} ${q.doctor?.full_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                                    <button class="action-btn view-btn" onclick="viewQuestionnaire(${q.id})">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
                                </div>
                            `;
                        });
                    }
                    
                    alert(`
                        ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${p.full_name}
                        ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${p.phone}
                        ğŸ‚ Ø§Ù„Ø¹Ù…Ø±: ${p.age || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                        ğŸ“‹ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨ÙŠ: ${p.medical_history || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
                        ğŸ’Š Ø§Ù„Ø£Ø¯ÙˆÙŠØ©: ${p.medications || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
                        âš ï¸ Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©: ${p.allergies || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
                    `);
                    
                    if (qData.questionnaires?.length > 0) {
                        console.log('Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:', qData.questionnaires);
                    }
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£:', error);
            }
        }
        
        // ============================================
        // Ø¹Ø±Ø¶ Ø§Ø³ØªØ¨ÙŠØ§Ù† Ù…Ø­Ø¯Ø¯
        // ============================================
        async function viewQuestionnaire(questionnaireId) {
            try {
                const { response, data } = await apiRequest(`/api/questionnaires/${questionnaireId}`);
                
                if (response.ok && data.success) {
                    const q = data.questionnaire;
                    let details = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†:\n\n';
                    
                    if (q.nutrition && Object.keys(q.nutrition).length > 0) {
                        details += 'ğŸ¥— Ø§Ù„ØªØºØ°ÙŠØ©:\n';
                        for (const [key, value] of Object.entries(q.nutrition)) {
                            if (value && key !== 'notes') {
                                details += `- ${key}: ${value}\n`;
                            }
                        }
                        if (q.nutrition.notes) details += `Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${q.nutrition.notes}\n`;
                    }
                    
                    if (q.dentistry && Object.keys(q.dentistry).length > 0) {
                        details += '\nğŸ¦· Ø§Ù„Ø£Ø³Ù†Ø§Ù†:\n';
                        for (const [key, value] of Object.entries(q.dentistry)) {
                            if (value && key !== 'notes') {
                                details += `- ${key}: ${value}\n`;
                            }
                        }
                        if (q.dentistry.notes) details += `Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${q.dentistry.notes}\n`;
                    }
                    
                    if (q.laser && Object.keys(q.laser).length > 0) {
                        details += '\nğŸ”¬ Ø§Ù„Ù„ÙŠØ²Ø±:\n';
                        for (const [key, value] of Object.entries(q.laser)) {
                            if (value && key !== 'notes') {
                                details += `- ${key}: ${value}\n`;
                            }
                        }
                        if (q.laser.notes) details += `Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${q.laser.notes}\n`;
                    }
                    
                    alert(details);
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£:', error);
            }
        }
        
        // ============================================
        // Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø·Ø¨ÙŠØ©
        // ============================================
        async function addMedicalNote(patientId) {
            const note = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø·Ø¨ÙŠØ©:');
            if (!note) return;
            
            try {
                const { response, data } = await apiRequest(`/api/patients/${patientId}/notes`, {
                    method: 'POST',
                    body: JSON.stringify({ note })
                });
                
                if (response.ok && data.success) {
                    alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©');
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£:', error);
            }
        }
        
        // ============================================
        // ØªØ­Ù…ÙŠÙ„ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…
        // ============================================
        async function loadTodayAppointments() {
            document.getElementById('pageTitle').textContent = 'Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…';
            
            const today = new Date().toISOString().split('T')[0];
            
            try {
                const { response, data } = await apiRequest(`/api/appointments/doctor/${currentUser.id}?date=${today}`);
                
                let html = '<div class="card"><h2 style="margin-bottom:20px;">ğŸ“… Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…</h2>';
                
                if (response.ok && data.appointments && data.appointments.length > 0) {
                    data.appointments.forEach(app => {
                        html += `
                            <div class="appointment-item" style="display:flex; align-items:center; padding:15px; border-bottom:1px solid #eee;">
                                <div style="background:#006D77; color:white; padding:8px 15px; border-radius:20px; margin-left:20px;">
                                    ${new Date(app.appointment_date).toLocaleTimeString('ar-SA')}
                                </div>
                                <div style="flex:1;">
                                    <strong>${app.patient?.full_name}</strong>
                                    <br>
                                    <small>ğŸ“ ${app.patient?.phone}</small>
                                </div>
                                <span class="status-badge status-${app.status}">
                                    ${app.status === 'pending' ? 'Ù…Ø¹Ù„Ù‚' : app.status === 'confirmed' ? 'Ù…Ø¤ÙƒØ¯' : app.status === 'completed' ? 'Ù…ÙƒØªÙ…Ù„' : 'Ù…Ù„ØºÙŠ'}
                                </span>
                                <div style="margin-right:15px;">
                                    <button class="btn-questionnaire" onclick="openQuestionnaire(${app.patient?.id}, '${app.patient?.full_name}')">ğŸ“ Ø§Ø³ØªØ¨ÙŠØ§Ù†</button>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="text-align:center; padding:30px;">âœ¨ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…</p>';
                }
                
                html += '</div>';
                document.getElementById('content').innerHTML = html;
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£:', error);
            }
        }
        
        // ============================================
        // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
        // ============================================
        async function loadAllAppointments() {
            document.getElementById('pageTitle').textContent = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯';
            
            try {
                const { response, data } = await apiRequest('/api/appointments');
                
                let html = '<div class="card"><h2 style="margin-bottom:20px;">ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</h2>';
                
                if (response.ok && data.appointments && data.appointments.length > 0) {
                    data.appointments.forEach(app => {
                        html += `
                            <div style="display:flex; align-items:center; padding:15px; border-bottom:1px solid #eee;">
                                <div style="background:#006D77; color:white; padding:8px 15px; border-radius:20px; margin-left:20px;">
                                    ${new Date(app.appointment_date).toLocaleString('ar-SA')}
                                </div>
                                <div style="flex:1;">
                                    <strong>${app.patient?.full_name}</strong>
                                    <br>
                                    <small>ğŸ‘¨â€âš•ï¸ ${app.doctor?.full_name}</small>
                                </div>
                                <span class="status-badge status-${app.status}">
                                    ${app.status === 'pending' ? 'Ù…Ø¹Ù„Ù‚' : app.status === 'confirmed' ? 'Ù…Ø¤ÙƒØ¯' : app.status === 'completed' ? 'Ù…ÙƒØªÙ…Ù„' : 'Ù…Ù„ØºÙŠ'}
                                </span>
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="text-align:center; padding:30px;">âœ¨ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯</p>';
                }
                
                html += '</div>';
                document.getElementById('content').innerHTML = html;
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£:', error);
            }
        }
        
        // ============================================
        // ØªØ­Ù…ÙŠÙ„ Ù…Ø±Ø¶Ø§ÙŠ (Ø¯ÙˆÙ† Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø³Ù…)
        // ============================================
        async function loadMyPatients() {
            document.getElementById('pageTitle').textContent = 'Ù…Ø±Ø¶Ø§ÙŠ';
            
            try {
                const { response, data } = await apiRequest('/api/patients');
                
                let html = `
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±Ø¶Ø§ÙŠ</h2>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                                        <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                                        <th>Ø§Ù„Ø¹Ù…Ø±</th>
                                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</th>
                                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                if (response.ok && data.patients && data.patients.length > 0) {
                    data.patients.forEach(patient => {
                        html += `
                            <tr>
                                <td><strong>${patient.full_name}</strong></td>
                                <td>${patient.phone}</td>
                                <td>${patient.age || '-'}</td>
                                <td>${new Date(patient.createdAt).toLocaleDateString('ar-SA')}</td>
                                <td>
                                    <button class="action-btn view-btn" onclick="viewPatientDetails(${patient.id})">ğŸ‘ï¸ Ø¹Ø±Ø¶</button>
                                    <button class="action-btn edit-btn" onclick="openQuestionnaire(${patient.id}, '${patient.full_name}')">ğŸ“ Ø§Ø³ØªØ¨ÙŠØ§Ù†</button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    html += `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 30px;">
                                âœ¨ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±Ø¶Ù‰ Ø¨Ø¹Ø¯
                            </td>
                        </tr>
                    `;
                }
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('content').innerHTML = html;
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£:', error);
            }
        }
        
        // ============================================
        // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        // ============================================
        function loadSettings() {
            document.getElementById('pageTitle').textContent = 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª';
            document.getElementById('content').innerHTML = `
                <div class="card">
                    <h2 style="margin-bottom:20px;">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
                    <p style="text-align:center; padding:30px;">Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø±ÙŠØ¨Ø§Ù‹</p>
                </div>
            `;
        }
        
        // ============================================
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        // ============================================
        function logout() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/login.html';
            }
        }
        
        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
        (async function init() {
            await loadUserData();
            showDepartments();
        })();
    </script>
</body>
</html>
