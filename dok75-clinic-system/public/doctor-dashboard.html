<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOK75 - Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ø¨ÙŠØ¨</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .schedule-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .time-slot {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .time-slot:last-child {
            border-bottom: none;
        }
        
        .slot-time {
            background: #006D77;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 20px;
            min-width: 100px;
            text-align: center;
        }
        
        .patient-info {
            flex: 1;
        }
        
        .patient-name {
            font-weight: 700;
            color: #2C3E50;
            margin-bottom: 5px;
        }
        
        .patient-phone {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="sidebar">
            <div class="logo">
                <h2>DOK75</h2>
                <span>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ø¨ÙŠØ¨</span>
            </div>
            
            <div class="user-info" id="userInfo">
                <div class="name">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                <div class="role">Ø·Ø¨ÙŠØ¨</div>
            </div>
            
            <ul class="menu">
                <li><a href="#" class="active" onclick="loadDashboard()">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                <li><a href="#" onclick="loadTodayAppointments()">ğŸ“… Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…</a></li>
                <li><a href="#" onclick="loadMyPatients()">ğŸ‘¥ Ù…Ø±Ø¶Ø§ÙŠ</a></li>
                <li><a href="#" onclick="loadSchedule()">â° Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„</a></li>
                <li><a href="#" onclick="logout()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
            </ul>
        </div>
        
        <div class="main-content">
            <div class="header">
                <h1 id="pageTitle">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h1>
            </div>
            
            <div id="content"></div>
        </div>
    </div>
    
    <script src="/js/main.js"></script>
    <script>
        if (!checkAuth()) {
            window.location.href = '/login.html';
        }
        
        let currentUser = null;
        
        async function loadUserData() {
            try {
                const data = await fetchWithLoading('/api/auth/me');
                if (data.success) {
                    currentUser = data.user;
                    document.querySelector('.user-info .name').textContent = currentUser.full_name;
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£:', error);
            }
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…
        async function loadTodayAppointments() {
            document.getElementById('pageTitle').textContent = 'Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…';
            
            const today = new Date().toISOString().split('T')[0];
            
            try {
                const data = await fetchWithLoading(`/api/appointments/doctor/${currentUser.id}?date=${today}`);
                
                let html = '<div class="schedule-card">';
                
                if (data.appointments?.length > 0) {
                    data.appointments.forEach(app => {
                        html += `
                            <div class="time-slot">
                                <div class="slot-time">
                                    ${new Date(app.appointment_date).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}
                                </div>
                                <div class="patient-info">
                                    <div class="patient-name">${app.patient?.full_name}</div>
                                    <div class="patient-phone">ğŸ“ ${app.patient?.phone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div>
                                </div>
                                <span class="badge badge-${app.status}">
                                    ${app.status === 'pending' ? 'Ù…Ø¹Ù„Ù‚' :
                                      app.status === 'confirmed' ? 'Ù…Ø¤ÙƒØ¯' :
                                      app.status === 'completed' ? 'Ù…ÙƒØªÙ…Ù„' : 'Ù…Ù„ØºÙŠ'}
                                </span>
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…</p>';
                }
                
                html += '</div>';
                document.getElementById('content').innerHTML = html;
            } catch (error) {
                console.error('Ø®Ø·Ø£:', error);
            }
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ù…Ø±Ø¶Ø§ÙŠ
        async function loadMyPatients() {
            document.getElementById('pageTitle').textContent = 'Ù…Ø±Ø¶Ø§ÙŠ';
            
            try {
                const data = await fetchWithLoading('/api/patients');
                
                let html = `
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±Ø¶Ø§ÙŠ</h2>
                            <button class="btn btn-primary" onclick="showAddPatient()">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶</button>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                                        <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                                        <th>Ø§Ù„Ø¹Ù…Ø±</th>
                                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                if (data.patients) {
                    data.patients.forEach(patient => {
                        html += `
                            <tr>
                                <td>${patient.full_name}</td>
                                <td>${patient.phone}</td>
                                <td>${patient.age || '-'}</td>
                                <td>
                                    <button class="action-btn view-btn" onclick="viewPatient(${patient.id})">ğŸ‘ï¸ Ø¹Ø±Ø¶</button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('content').innerHTML = html;
            } catch (error) {
                console.error('Ø®Ø·Ø£:', error);
            }
        }
        
        // Ø¹Ø±Ø¶ Ù…Ø±ÙŠØ¶
        async function viewPatient(patientId) {
            try {
                const data = await fetchWithLoading(`/api/patients/${patientId}`);
                
                if (data.success) {
                    const p = data.patient;
                    alert(`
                        Ø§Ù„Ø§Ø³Ù…: ${p.full_name}
                        Ø§Ù„Ù‡Ø§ØªÙ: ${p.phone}
                        Ø§Ù„Ø¹Ù…Ø±: ${p.age || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                        Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨ÙŠ: ${p.medical_history || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
                        Ø§Ù„Ø£Ø¯ÙˆÙŠØ©: ${p.medications || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
                    `);
                }
            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£');
            }
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶
        async function showAddPatient() {
            const full_name = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶:');
            if (!full_name) return;
            
            const phone = prompt('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:');
            if (!phone) return;
            
            const age = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù…Ø±:');
            
            try {
                const data = await fetchWithLoading('/api/patients', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        full_name, 
                        phone, 
                        age: age ? parseInt(age) : null,
                        clinic_id: currentUser.clinic_id 
                    })
                });
                
                if (data.success) {
                    alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­');
                    loadMyPatients();
                }
            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£');
            }
        }
        
        function loadDashboard() {
            document.getElementById('pageTitle').textContent = 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©';
            loadTodayAppointments();
        }
        
        function loadSchedule() {
            document.getElementById('pageTitle').textContent = 'Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„';
            document.getElementById('content').innerHTML = '<p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';
        }
        
        loadUserData();
        loadDashboard();
    </script>
</body>
</html>
