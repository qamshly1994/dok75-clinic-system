/**
 * ============================================
 * DOK75 - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„
 * Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ (Ù†Ø³Ø®Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©)
 * ============================================
 */

// Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
const express = require('express');
const dotenv = require('dotenv');
const cors = require('cors');
const helmet = require('helmet');
const path = require('path');
const fs = require('fs');

// ØªØ­Ù…ÙŠÙ„ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
dotenv.config();

// Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
const { sequelize } = require('./models');

// Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¯Ø§Ù„Ø© Auto Seed
const seedAdmin = require('./scripts/seed');

// Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª (Routes)
const authRoutes = require('./routes/auth');
const userRoutes = require('./routes/users');
const patientRoutes = require('./routes/patients');
const appointmentRoutes = require('./routes/appointments');
const questionnaireRoutes = require('./routes/questionnaires');

// Ø¥Ù†Ø´Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ Express
const app = express();

// ============================================
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„ÙˆØ³Ø§Ø¦Ø· (Middleware)
// ============================================

// Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø±Ø¤ÙˆØ³ (Helmet)
app.use(helmet({
    contentSecurityPolicy: false,
    crossOriginEmbedderPolicy: false
}));

// ØªÙ…ÙƒÙŠÙ† CORS Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
app.use(cors({
    origin: process.env.CORS_ORIGIN || '*',
    credentials: true
}));

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Body Parser)
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© (Static Files)
app.use(express.static(path.join(__dirname, 'public')));

// ============================================
// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª (Routes)
// ============================================

// Ù…Ø³Ø§Ø±Ø§Øª API
app.use('/api/auth', authRoutes);
app.use('/api/users', userRoutes);
app.use('/api/patients', patientRoutes);
app.use('/api/appointments', appointmentRoutes);
app.use('/api/questionnaires', questionnaireRoutes);

// ============================================
// Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Frontend)
// ============================================

// Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'login.html'));
});

// ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø¨Ø¯ÙŠÙ„)
app.get('/login', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'login.html'));
});

// Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø¹Ø§Ù…
app.get('/admin-dashboard', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'admin-dashboard.html'));
});

// Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ø¨ÙŠØ¨
app.get('/doctor-dashboard', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'doctor-dashboard.html'));
});

// Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù…ÙˆØ¸Ù Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„
app.get('/reception-dashboard', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'reception-dashboard.html'));
});

// Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø¹Ø§Ù…Ø© (ØªÙˆØ¬ÙŠÙ‡ Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±)
app.get('/dashboard', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'dashboard.html'));
});

// ============================================
// Ù…Ø³Ø§Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø®Ø§Ø¯Ù…
// ============================================

app.get('/api/health', (req, res) => {
    res.json({
        status: 'âœ… Ù†Ø¸Ø§Ù… DOK75 Ø´ØºØ§Ù„',
        time: new Date().toLocaleString('ar-SA'),
        developer: process.env.DEV_NAME,
        phone: process.env.DEV_PHONE,
        version: '2.1.0'
    });
});

// ============================================
// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
// ============================================

// Ù…Ø³Ø§Ø± 404 - ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
app.use('*', (req, res) => {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ ÙŠØ·Ù„Ø¨ ØµÙØ­Ø© HTML
    if (req.accepts('html')) {
        res.status(404).sendFile(path.join(__dirname, 'public', '404.html'));
    } else {
        res.status(404).json({ 
            error: 'âŒ Ø§Ù„Ù…Ø³Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯',
            message: 'ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ø§Ø¨Ø·' 
        });
    }
});

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø®Ø§Ø¯Ù… (500)
app.use((err, req, res, next) => {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…:', err);
    res.status(500).json({ 
        error: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…',
        message: process.env.NODE_ENV === 'development' ? err.message : undefined
    });
});

// ============================================
// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù… ÙˆØ§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
// ============================================

const PORT = process.env.PORT || 3000;

// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ logs Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
const logsDir = path.join(__dirname, 'logs');
if (!fs.existsSync(logsDir)) {
    fs.mkdirSync(logsDir, { recursive: true });
}

// Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
const startServer = async () => {
    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
        await sequelize.authenticate();
        console.log('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª PostgreSQL Ø¨Ù†Ø¬Ø§Ø­');

        // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ (Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©)
        await sequelize.sync({ alter: true });
        console.log('âœ… ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        // âœ… ØªØ´ØºÙŠÙ„ Auto Seed Admin (Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø¹Ø§Ù… Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹)
        await seedAdmin();
        console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø¹Ø§Ù…');

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…
        app.listen(PORT, () => {
            console.log('=================================');
            console.log(`ðŸš€ Ø®Ø§Ø¯Ù… DOK75 Ø´ØºØ§Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° ${PORT}`);
            console.log(`ðŸ“± Ø§ÙØªØ­ Ø§Ù„Ù…ØªØµÙØ­: http://localhost:${PORT}`);
            console.log(`ðŸ‘¤ Ø§Ù„Ù…Ø·ÙˆØ±: ${process.env.DEV_NAME}`);
            console.log(`ðŸ“ž Ù„Ù„ØªÙˆØ§ØµÙ„: ${process.env.DEV_PHONE}`);
            console.log('=================================');
            console.log('ðŸ“Œ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:');
            console.log('   - /');
            console.log('   - /login');
            console.log('   - /admin-dashboard');
            console.log('   - /doctor-dashboard');
            console.log('   - /reception-dashboard');
            console.log('   - /dashboard');
            console.log('=================================');
        });

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        process.exit(1);
    }
};

// ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
startServer();

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
process.on('SIGINT', async () => {
    await sequelize.close();
    console.log('ðŸ“´ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    process.exit(0);
});

process.on('SIGTERM', async () => {
    await sequelize.close();
    console.log('ðŸ“´ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    process.exit(0);
});
